name: d3d-vkd3d-arm64ec-hosted

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: "(v2.14.1, v3.0a) Empty = Latest"
  schedule:
    - cron: "0 17 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  GH_TOKEN:       ${{ github.token }}
  UNI_KIND:       vkd3d-proton-arm64ec
  REL_TAG_STABLE: VKD3D-PROTON-ARM64EC
  UPSTREAM_REPO:  HansKristian-Work/vkd3d-proton

jobs:
  build:
    name: Build & Pack
    # This force-uses GitHub's hosted runners
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Increased to the 6-hour maximum
    
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # This frees up ~30GB of space
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Guard
        id: check
        run: |
          # Ensure scripts are executable
          chmod +x ./scripts/*.sh
          # Set input version if manually triggered
          export IN_VERSION="${{ github.event.inputs.version }}"
          bash ./scripts/guard.sh
          # Note: guard.sh must set 'missing' and 'list' outputs for the next steps

      - name: Install Deps
        if: steps.check.outputs.missing == 'true'
        run: bash ./scripts/install-deps-ubuntu.sh

      - name: Setup Build Env (Meson + llvm-mingw)
        if: steps.check.outputs.missing == 'true'
        run: bash ./scripts/setup-llvm-meson.sh

      - name: Clone Source
        if: steps.check.outputs.missing == 'true'
        run: |
          git clone "https://github.com/$UPSTREAM_REPO.git" src
          git -C src config user.name "Builder"
          git -C src config user.email "bot@noreply"

      - name: Build Loop
        if: steps.check.outputs.missing == 'true'
        env:
          TO_BUILD: ${{ steps.check.outputs.list }}
        run: |
          mkdir -p _logs out src/out
          cd src
          git fetch --tags --force

          while IFS='|' read -r kind channel ref ver_name rel_tag filename short; do
            [[ -n "$kind" ]] || continue
            LOG_PATH="../_logs/${UNI_KIND}-${ver_name}-build.log"
            echo "::group::Building ${ref} (${ver_name})"
            
            git reset --hard
            git clean -fdx
            git checkout -f "$ref"
            git submodule update --init --recursive

            # The actual compilation script
            bash ../scripts/guts-arm64ec.sh "$ref" "$ver_name" "$filename"
            
            echo "::endgroup::"
          done <<< "$TO_BUILD"

      - name: Process Logs
        if: always()
        run: bash ./scripts/log.sh _logs/*.log || true

      - name: Release
        if: steps.check.outputs.missing == 'true'
        env:
          REPO:           ${{ github.repository }}
          REL_TAG:        ${{ env.REL_TAG_STABLE }} 
          VERSION_PREFIX: "${{ env.UNI_KIND }}-"
          ARTIFACT_GLOB:  "out/${{ env.UNI_KIND }}-*.wcp"
        run: bash ./scripts/release.sh
        
