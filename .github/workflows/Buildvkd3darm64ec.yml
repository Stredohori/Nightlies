name: d3d-vkd3d-arm64ec-force-build

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: "(v2.14.1, v3.0a) Empty = Latest Stable from Upstream"
  schedule:
    - cron: "0 17 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  GH_TOKEN:       ${{ github.token }}
  UNI_KIND:       vkd3d-proton-arm64ec
  REL_TAG_STABLE: VKD3D-PROTON-ARM64EC
  UPSTREAM_REPO:  HansKristian-Work/vkd3d-proton

jobs:
  build:
    name: Build & Pack
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Deps
        run: |
          chmod +x ./scripts/*.sh
          bash ./scripts/install-deps-ubuntu.sh

      - name: Setup Build Env (Meson + llvm-mingw)
        run: bash ./scripts/setup-llvm-meson.sh

      - name: Clone Source
        run: |
          git clone "https://github.com/$UPSTREAM_REPO.git" src
          git -C src config user.name "Builder"
          git -C src config user.email "bot@noreply"

      - name: Build Latest/Specified Version
        run: |
          mkdir -p _logs out src/out
          cd src
          git fetch --tags --force
          
          # Determine which version to build
          if [ -n "${{ github.event.inputs.version }}" ]; then
            REF="${{ github.event.inputs.version }}"
            VER_NAME="${{ github.event.inputs.version }}"
          else
            # Grab the latest tag from the upstream repository
            REF=$(git describe --tags $(git rev-list --tags --max-count=1))
            VER_NAME="$REF"
          fi
          
          FILENAME="${UNI_KIND}-${VER_NAME}.wcp"
          LOG_PATH="../_logs/${UNI_KIND}-${VER_NAME}-build.log"

          echo "::group::Building ${REF}"
          
          git reset --hard
          git clean -fdx
          git checkout -f "$REF"
          git submodule update --init --recursive

          # Run the actual compilation
          bash ../scripts/guts-arm64ec.sh "$REF" "$VER_NAME" "$FILENAME"
          
          echo "::endgroup::"

      - name: Process Logs
        if: always()
        run: bash ./scripts/log.sh _logs/*.log || true

      - name: Release
        env:
          REPO:           ${{ github.repository }}
          REL_TAG:        ${{ env.REL_TAG_STABLE }} 
          VERSION_PREFIX: "${{ env.UNI_KIND }}-"
          ARTIFACT_GLOB:  "out/${{ env.UNI_KIND }}-*.wcp"
        run: bash ./scripts/release.sh
