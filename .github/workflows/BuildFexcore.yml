name: Build FEXCore (ARM64EC)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # Updated to 22.04 to match the likely toolchain requirement

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential wget tar

    - name: Setup LLVM-MinGW Toolchain
      run: |
        # UPDATED: Changed version from 20240917 to 20250917 to support arm64ec
        # If this fails, check https://github.com/mstorsjo/llvm-mingw/releases for the latest tag
        wget https://github.com/mstorsjo/llvm-mingw/releases/download/20250917/llvm-mingw-20250917-ucrt-ubuntu-20.04-x86_64.tar.xz
        tar -xf llvm-mingw-20250917-ucrt-ubuntu-20.04-x86_64.tar.xz
        
        # Add toolchain to PATH for subsequent steps
        echo "$(pwd)/llvm-mingw-20250917-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH

    - name: Build libarm64ec.dll (ARM64EC)
      run: |
        mkdir build-arm64ec
        cd build-arm64ec

        # Configure for ARM64EC (Windows on ARM64)
        # We explicitly set the C and CXX compilers to ensure CMake finds them in the new toolchain
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
          -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
          -DCMAKE_INSTALL_PREFIX=./install \
          -DENABLE_LTO=False \
          -DBUILD_TESTING=False \
          -DCMAKE_C_COMPILER=arm64ec-w64-mingw32-clang \
          -DCMAKE_CXX_COMPILER=arm64ec-w64-mingw32-clang++

        ninja
        
        # Note: The output filename in FEX source is usually libarm64ecfex.dll
        # We will rename it during packaging to match your 'libarm64ec.dll'

    - name: Prepare Artifacts
      run: |
        mkdir artifacts
        # Find the built DLL. The name might vary slightly depending on CMake config, 
        # so we find it by extension in the build directory.
        find build-arm64ec -name "*.dll" -exec cp {} artifacts/libarm64ec.dll \;

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fex-arm64ec
        path: artifacts/
