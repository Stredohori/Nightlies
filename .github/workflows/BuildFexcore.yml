name: Build FEXCore Native Nightly

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm # Native ARM64 runner is 10x faster for this
    
    steps:
    - name: Checkout FEX
      uses: actions/checkout@v4
      with:
        repository: FEX-Emu/FEX
        path: fex
        submodules: recursive
        fetch-depth: 0

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # Standard native dependencies including Qt6 for FEXConfig
        sudo apt-get install -y cmake ninja-build clang llvm lld libssl-dev \
          python3-setuptools qt6-base-dev qt6-declarative-dev libsdl2-dev

    - name: Configure and Build
      run: |
        mkdir build && cd build
        # We build for 'Host' (Linux Native) instead of cross-compiling
        CC=clang CXX=clang++ cmake ../fex \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_LINKER=lld \
          -DENABLE_LTO=True \
          -DBUILD_TESTING=False \
          -G Ninja
        ninja FEXInterpreter FEXLoader FEXServer FEXConfig

    - name: Prepare Package
      run: |
        COMMIT_HASH=$(git -C fex rev-parse --short HEAD)
        BUILD_DATE=$(date +'%Y-%m-%d')

        mkdir -p packaging/usr/local/bin
        # Copy the main native Linux tools
        cp build/Source/Tools/FEXInterpreter/FEXInterpreter packaging/usr/local/bin/
        cp build/Source/Tools/FEXLoader/FEXLoader packaging/usr/local/bin/
        cp build/Source/Tools/FEXServer/FEXServer packaging/usr/local/bin/
        cp build/Source/Tools/FEXConfig/FEXConfig packaging/usr/local/bin/

        cat <<EOF > packaging/profile.json
        {
          "type": "FEXCore-Native",
          "versionName": "fex-native-${COMMIT_HASH}",
          "versionCode": ${{ github.run_number }},
          "description": "FEXCore Native Linux ARM64\nCommit: ${COMMIT_HASH}\nDate: ${BUILD_DATE}",
          "author": "Blank",
          "files": [
            { "source": "usr/local/bin/FEXInterpreter", "target": "/usr/local/bin/FEXInterpreter" }
          ]
        }
        EOF

        tar -cJf "fex-native-${COMMIT_HASH}.wcp" -C packaging .

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fex-native-nightly
        path: "*.wcp"
