name: Fetch FEXCore Nightly (From Upstream)

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:      # Allows manual trigger

jobs:
  fetch-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create releases if you add that later
      actions: read   # Needed to download artifacts

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Find and Download Latest Artifact
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 1. Find the latest successful run ID for the 'wine_dll_artifacts.yml' workflow on branch 'main'
        # We filter for status=success and branch=main to ensure we get a good build.
        RUN_ID=$(gh run list --repo FEX-Emu/FEX --workflow wine_dll_artifacts.yml --branch main --status success --limit 1 --json databaseId --jq '.[0].databaseId')
        
        echo "Found latest successful run ID: $RUN_ID"
        
        # 2. Download the 'wine-dll-artifacts' from that run
        gh run download $RUN_ID --repo FEX-Emu/FEX --name wine-dll-artifacts --dir downloaded_artifacts

    - name: Repackage DLLs
      run: |
        # Create your specific directory structure
        mkdir -p packaging/system32
        
        # Copy and RENAME the files as per your previous request
        # FEX upstream names them 'libarm64ecfex.dll', you wanted 'libarm64ec.dll'
        cp downloaded_artifacts/libarm64ecfex.dll packaging/system32/libarm64ec.dll
        cp downloaded_artifacts/libwow64fex.dll packaging/system32/libwow64fex.dll

    - name: Create profile.json
      run: |
        # Generate dynamic variables for the JSON
        BUILD_DATE=$(date +'%Y-%m-%d')
        # We use the current repo's run number for version code, or you can fetch the upstream commit hash if preferred
        VERSION_CODE=${{ github.run_number }}
        
        # Create the JSON file
        cat <<EOF > packaging/profile.json
        {
          "type": "FEXCore",
          "versionName": "Nightly-${BUILD_DATE}",
          "versionCode": ${VERSION_CODE},
          "description": "FEXCore Nightly (Upstream Artifacts)\nDate: ${BUILD_DATE}",
          "author": "The412Banner",
          "files": [
            { "source": "system32/libarm64ec.dll", "target": "\${system32}/libarm64ec.dll" },
            { "source": "system32/libwow64fex.dll", "target": "\${system32}/libwow64fex.dll" }
          ]
        }
        EOF

    - name: Upload Repackaged Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fex-nightly-package
        path: packaging/
