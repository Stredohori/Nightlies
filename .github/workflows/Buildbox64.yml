name: Build Box64 Nightly

on:
  schedule:
    - cron: '0 2 * * *' # Runs daily at 2 AM
  workflow_dispatch:

jobs:
  build:
    # Use the native ARM64 runner (Free for public repos)
    # This fixes the 'no such instruction' errors
    runs-on: ubuntu-24.04-arm
    
    strategy:
      matrix:
        include:
          - platform: "RK3588"
            flags: "-DRK3588=1"
          - platform: "SD845"
            flags: "-DSD845=1"
          - platform: "GENERIC_ARM64"
            flags: "-DARM64=1"

    steps:
    - name: Checkout Box64
      uses: actions/checkout@v4
      with:
        repository: ptitSeb/box64
        path: box64
        fetch-depth: 0 # Fetch history for correct commit info

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential

    - name: Configure and Build
      run: |
        mkdir build && cd build
        # We build natively on ARM64, so no cross-compiler needed
        cmake ../box64 ${{ matrix.flags }} -DCMAKE_BUILD_TYPE=Release -G Ninja
        ninja

    - name: Generate Changelog
      run: |
        cd box64
        git log --since="24 hours ago" > ../changelog.txt

    - name: Prepare Package
      run: |
        # 1. Capture Commit Hash and Date
        cd box64
        COMMIT_HASH=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date +'%Y-%m-%d')
        cd ..

        # 2. Create directory structure
        # Box64 usually goes into /usr/local/bin
        mkdir -p packaging/usr/local/bin
        cp build/box64 packaging/usr/local/bin/
        cp changelog.txt packaging/

        # 3. Create profile.json (Matches your DXVK format)
        cat <<EOF > packaging/profile.json
        {
          "type": "Box64",
          "versionName": "nightly-${{ matrix.platform }}-${COMMIT_HASH}",
          "versionCode": ${{ github.run_number }},
          "description": "Box64 Nightly for ${{ matrix.platform }}\nCommit: ${COMMIT_HASH}\nDate: ${BUILD_DATE}",
          "author": "Blank",
          "files": [
            { "source": "usr/local/bin/box64", "target": "/usr/local/bin/box64" }
          ]
        }
        EOF

        # 4. Create the final archive
        # Using .wcp extension to match your DXVK workflow style
        tar -cJf "box64-${{ matrix.platform }}-${COMMIT_HASH}.wcp" -C packaging .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: box64-${{ matrix.platform }}-nightly
        path: |
          *.wcp
          changelog.txt
