name: Build Turnip

on:
  workflow_dispatch:

jobs:
  build-turnip:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Prepare environment
      run: |
        sudo apt-get update
        # build-dep grabs standard tools (bison, flex, python libs)
        sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources
        sudo apt-get update
        sudo apt-get build-dep mesa -y
        
        # Install Android-specific tools and latest Meson
        sudo apt-get install -y libxml2-utils glslang-tools python3-pip
        sudo pip3 install meson --break-system-packages

    - name: Setup Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
        unzip -q android-ndk-r26b-linux.zip
        echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26b" >> $GITHUB_ENV

    - name: Clone Mesa & LibDRM
      run: |
        # Clone Mesa (Drivers) and LibDRM (Dependency)
        git clone --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git
        git clone --depth 1 https://gitlab.freedesktop.org/mesa/drm.git libdrm
        
        # Move libdrm so Mesa finds it automatically
        mv libdrm mesa/subprojects/
        
        cd mesa
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "COMMIT_HASH=${COMMIT_HASH}" >> $GITHUB_ENV

    - name: Build Turnip
      run: |
        cd mesa
        
        # Create the specific instruction file for Android compiling
        cat <<EOF > android-aarch64
        [binaries]
        c = '${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android29-clang'
        cpp = '${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android29-clang++'
        ar = '${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
        strip = '${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
        pkgconfig = 'false'
        [host_machine]
        system = 'android'
        cpu_family = 'aarch64'
        cpu = 'aarch64'
        endian = 'little'
        EOF

        # Configure and Build
        meson setup build-android \
          --cross-file android-aarch64 \
          -Dplatforms= \
          -Dgallium-drivers= \
          -Dvulkan-drivers=freedreno \
          -Dllvm=disabled \
          -Dbuildtype=release \
          --force-fallback-for=libdrm
        
        ninja -C build-android

    - name: Package Turnip
      run: |
        mkdir -p turnip-package
        cp mesa/build-android/src/freedreno/vulkan/libvulkan_freedreno.so turnip-package/
        
        # Create a simple version file
        echo "Turnip Version: ${{ env.COMMIT_HASH }}" > turnip-package/version.txt

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: turnip-driver-${{ env.COMMIT_HASH }}
        path: turnip-package/*

    - name: Release Turnip
      uses: softprops/action-gh-release@v1
      with:
        tag_name: turnip-${{ env.COMMIT_HASH }}
        name: "Turnip Driver: ${{ env.COMMIT_HASH }}"
        body: "Latest Turnip Vulkan driver built from Mesa source."
        files: turnip-package/libvulkan_freedreno.so
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
