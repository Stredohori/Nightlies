name: Build WowBox64 Nightly

on:
  schedule:
    - cron: '30 2 * * *' # Runs at 2:30 AM (after the main Box64 build)
  workflow_dispatch:

jobs:
  build:
    # Native ARM64 runner (Free for public repos)
    runs-on: ubuntu-24.04-arm
    
    strategy:
      matrix:
        include:
          - platform: "RK3588"
            flags: "-DRK3588=1"
          - platform: "SD845"
            flags: "-DSD845=1"
          - platform: "GENERIC_ARM64"
            flags: "-DARM64=1"

    steps:
    - name: Checkout Box64
      uses: actions/checkout@v4
      with:
        repository: ptitSeb/box64
        path: box64
        fetch-depth: 0

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential

    - name: Configure and Build WowBox64
      run: |
        mkdir build && cd build
        # The -DWOWBOX64=1 flag builds the DLL instead of the standalone binary
        cmake ../box64 ${{ matrix.flags }} -DWOWBOX64=1 -DCMAKE_BUILD_TYPE=Release -G Ninja
        ninja

    - name: Prepare Package
      run: |
        # 1. Capture Commit Hash and Date
        cd box64
        COMMIT_HASH=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date +'%Y-%m-%d')
        cd ..

        # 2. Create the internal folder structure for the .wcp
        # This path is standard for Wine/Hangover integrations
        mkdir -p packaging/usr/local/lib/wine/x86_64-unix
        
        # 3. Use find to locate the DLL regardless of where Ninja put it
        # This fixes the "cannot stat: No such file" error
        find build -name "wowbox64.dll*" -exec cp {} packaging/usr/local/lib/wine/x86_64-unix/ \;
        
        # Safety check: Stop if no files were found
        if [ -z "$(ls -A packaging/usr/local/lib/wine/x86_64-unix/)" ]; then
          echo "Error: wowbox64.dll was not found in the build folder!"
          exit 1
        fi

        # 4. Create profile.json matching your original format
        cat <<EOF > packaging/profile.json
        {
          "type": "WowBox64",
          "variant": "${{ matrix.platform }}",
          "versionName": "wow-nightly-${COMMIT_HASH}",
          "versionCode": ${{ github.run_number }},
          "description": "WowBox64 (WOW64 DLL) for ${{ matrix.platform }}\nCommit: ${COMMIT_HASH}\nDate: ${BUILD_DATE}",
          "author": "Blank"
        }
        EOF

        # 5. Compress into the final .wcp archive
        tar -cJf "wowbox64-${{ matrix.platform }}-${COMMIT_HASH}.wcp" -C packaging .

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wowbox64-${{ matrix.platform }}-nightly
        path: "*.wcp"
